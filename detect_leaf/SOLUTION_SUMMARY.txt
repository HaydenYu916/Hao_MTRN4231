================================================================================
ğŸŒ¿ å¶å­æ£€æµ‹åæ ‡è½¬æ¢ç³»ç»Ÿ - å®Œæ•´è§£å†³æ–¹æ¡ˆ
================================================================================

æ‚¨çš„é—®é¢˜ï¼š
  "å½“æˆ‘detect leafï¼Œå¦‚ä½•transferåˆ° @setupFakeur5e.sh arm coordinate?"

æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼šâœ… å·²å®Œå…¨å®ç°

================================================================================
ğŸ“¦ æ–°å¢æ–‡ä»¶åˆ—è¡¨
================================================================================

1. æ ¸å¿ƒè½¬æ¢èŠ‚ç‚¹ â­ (æœ€é‡è¦)
   ğŸ“ src/detect_leaf_pkg/detect_leaf_pkg/
   ğŸ“„ leaf_to_arm_transformer.py
   
   è¿™ä¸ªèŠ‚ç‚¹ï¼š
   â€¢ è®¢é˜…å¶å­æ£€æµ‹è¯é¢˜ (/leaf_detection/coordinates)
   â€¢ è¯»å–RealSenseæ·±åº¦å›¾åƒå’Œç›¸æœºå†…å‚
   â€¢ è‡ªåŠ¨è½¬æ¢åƒç´ åæ ‡ â†’ ç›¸æœº3Dåæ ‡ â†’ æœºæ¢°è‡‚åæ ‡
   â€¢ å‘å¸ƒç»“æœåˆ° /leaf_detection/arm_target

2. ç®€å•ç¤ºä¾‹
   ğŸ“ examples/
   ğŸ“„ simple_leaf_to_arm_example.py
   
   å­¦ä¹ ç”¨ç¤ºä¾‹ï¼Œå±•ç¤ºæ•´ä¸ªè½¬æ¢æµç¨‹

3. è¯¦ç»†æ–‡æ¡£
   ğŸ“„ ä¸­æ–‡æ€»ç»“.md â† ğŸ‘ˆ ä»è¿™é‡Œå¼€å§‹ï¼
   ğŸ“„ README_COORDINATE_TRANSFORM.md
   ğŸ“„ LEAF_TO_ARM_GUIDE.md
   ğŸ“„ QUICK_START.md
   ğŸ“„ ARCHITECTURE.md

4. æ›´æ–°çš„å¯åŠ¨è„šæœ¬
   ğŸ“„ start_full_system.sh (å·²æ›´æ–°ï¼Œè‡ªåŠ¨å¯åŠ¨è½¬æ¢èŠ‚ç‚¹)

================================================================================
âš¡ 3åˆ†é’Ÿå¿«é€Ÿå¼€å§‹
================================================================================

æ–¹å¼1ï¼šè‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$ cd /home/hao/Desktop/4231SuppliedCode/detect_leaf
$ ./start_full_system.sh

è¿™ä¼šå¯åŠ¨ï¼š
  âœ“ RealSenseç›¸æœº
  âœ“ å¶å­æ£€æµ‹èŠ‚ç‚¹
  âœ“ åæ ‡è½¬æ¢èŠ‚ç‚¹ â­ (æ–°å¢)
  âœ“ RViz2å¯è§†åŒ–

æ–¹å¼2ï¼šæ‰‹åŠ¨å¯åŠ¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç»ˆç«¯1: $ cd /home/hao/Desktop/4231SuppliedCode && ./4231_scripts/camera.sh
ç»ˆç«¯2: $ cd detect_leaf && source install/setup.bash && ros2 run detect_leaf_pkg leaf_detector
ç»ˆç«¯3: $ cd detect_leaf && source install/setup.bash && ros2 run detect_leaf_pkg leaf_to_arm_transformer â­
ç»ˆç«¯4: $ ros2 launch ur_robot_driver ur_control.launch.py ur_type:=ur5e use_fake_hardware:=true

éªŒè¯ç³»ç»Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€
$ ros2 topic echo /leaf_detection/arm_target

åº”è¯¥çœ‹åˆ°ï¼š
  header:
    frame_id: base_link  â† æœºæ¢°è‡‚åæ ‡ç³»ï¼
  pose:
    position:
      x: 0.123
      y: -0.045
      z: 0.567

================================================================================
ğŸ”„ å·¥ä½œåŸç†ï¼ˆä¸¤æ­¥è½¬æ¢ï¼‰
================================================================================

Step 1: åƒç´ åæ ‡ â†’ 3Dç›¸æœºåæ ‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥ï¼šåƒç´ åæ ‡ (360, 240) [æ¥è‡ªå¶å­æ£€æµ‹]
      æ·±åº¦å€¼: 0.5 m [æ¥è‡ªRealSenseæ·±åº¦ç›¸æœº]
      ç›¸æœºå†…å‚: fx, fy, cx, cy

è®¡ç®—ï¼šä½¿ç”¨RealSenseçš„åæŠ•å½±å‡½æ•°
  x = (pixel_x - cx) * depth / fx
  y = (pixel_y - cy) * depth / fy
  z = depth

è¾“å‡ºï¼šç›¸æœºåæ ‡ (0.0325, 0.0, 0.5) m


Step 2: ç›¸æœºåæ ‡ â†’ æœºæ¢°è‡‚åæ ‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥ï¼šç›¸æœºåæ ‡ (0.0325, 0.0, 0.5) m
      TFå˜æ¢ (ä»ROSæŸ¥è¯¢)

è®¡ç®—ï¼šä½¿ç”¨TF2åˆšä½“å˜æ¢
  T = lookup_transform('base_link', 'camera_color_optical_frame')
  p_arm = T Ã— p_camera

è¾“å‡ºï¼šæœºæ¢°è‡‚åæ ‡ (0.123, -0.045, 0.567) m
      frame_id: "base_link"

================================================================================
ğŸ“¡ ROSè¯é¢˜æµç¨‹
================================================================================

/camera/camera/color/image_raw (RGBå›¾åƒ)
    â†“
/camera/camera/aligned_depth_to_color/image_raw (æ·±åº¦å›¾)
    â†“
[å¶å­æ£€æµ‹å¤„ç†]
    â†“
/leaf_detection/coordinates (åƒç´ åæ ‡JSON)
    â†“
[åæ ‡è½¬æ¢å¤„ç†] â­ æ–°å¢èŠ‚ç‚¹åœ¨è¿™é‡Œ
    â†“
/leaf_detection/arm_target (æœºæ¢°è‡‚åæ ‡) â† æ‚¨è¦çš„ç»“æœï¼
    â†“
[æœºæ¢°è‡‚é©±åŠ¨/MoveIt]
    â†“
æœºæ¢°è‡‚æ‰§è¡ŒåŠ¨ä½œ

================================================================================
âœ… éªŒè¯ç³»ç»Ÿå·¥ä½œ
================================================================================

æ£€æŸ¥1ï¼šç›¸æœºæ˜¯å¦å·¥ä½œ
$ ros2 topic echo /camera/camera/color/image_raw --once
åº”è¯¥çœ‹åˆ°å›¾åƒæ•°æ®

æ£€æŸ¥2ï¼šå¶å­æ˜¯å¦è¢«æ£€æµ‹
$ ros2 topic echo /leaf_detection/coordinates
åº”è¯¥çœ‹åˆ°JSONæ ¼å¼çš„å¶å­åæ ‡

æ£€æŸ¥3ï¼šåæ ‡æ˜¯å¦è½¬æ¢æˆåŠŸ â­
$ ros2 topic echo /leaf_detection/arm_target
åº”è¯¥çœ‹åˆ°PoseStampedæ ¼å¼çš„æœºæ¢°è‡‚åæ ‡

æ£€æŸ¥4ï¼šTFå˜æ¢æ˜¯å¦å­˜åœ¨
$ ros2 run tf2_ros tf2_echo base_link camera_color_optical_frame
åº”è¯¥çœ‹åˆ°å˜æ¢çŸ©é˜µ

================================================================================
ğŸ”§ é…ç½®å‚æ•°ï¼ˆé€šå¸¸ä¸éœ€è¦æ”¹ï¼‰
================================================================================

ä½ç½®ï¼šsrc/detect_leaf_pkg/detect_leaf_pkg/leaf_to_arm_transformer.py

# ç¬¬82è¡Œï¼šç›¸æœºåæ ‡ç³»åç§°
camera_frame = 'camera_color_optical_frame'

# ç¬¬83è¡Œï¼šæœºæ¢°è‡‚åŸºåº§åæ ‡ç³»åç§°  
arm_base_frame = 'base_link'

# ç¬¬84è¡Œï¼šæ·±åº¦åç§»ï¼ˆæ ¹æ®ç›¸æœºå®‰è£…ä½ç½®è°ƒæ•´ï¼‰
depth_offset = 0.038  # å•ä½ï¼šç±³

================================================================================
ğŸ› å¸¸è§é—®é¢˜è§£å†³
================================================================================

é—®é¢˜1ï¼šæ— æ³•çœ‹åˆ° /leaf_detection/arm_target è¯é¢˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç—‡çŠ¶ï¼šros2 topic echo /leaf_detection/arm_target æ²¡æœ‰è¾“å‡º

åŸå› ï¼š
  â€¢ åæ ‡è½¬æ¢èŠ‚ç‚¹æ²¡å¯åŠ¨
  â€¢ æ²¡æœ‰æ£€æµ‹åˆ°å¶å­ï¼ˆæ— è¾“å…¥ï¼‰
  â€¢ æœºæ¢°è‡‚é©±åŠ¨æ²¡å¯åŠ¨ï¼ˆTFç¼ºå¤±ï¼‰

è§£å†³ï¼š
$ ros2 node list | grep leaf_to_arm
$ ros2 run detect_leaf_pkg leaf_to_arm_transformer

é—®é¢˜2ï¼šåæ ‡è½¬æ¢è¯´"TFå˜æ¢å¤±è´¥"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç—‡çŠ¶ï¼šCannot transform frame

åŸå› ï¼šæœºæ¢°è‡‚é©±åŠ¨æ²¡å¯åŠ¨

è§£å†³ï¼š
$ ros2 launch ur_robot_driver ur_control.launch.py \
  ur_type:=ur5e use_fake_hardware:=true

é—®é¢˜3ï¼šåæ ‡è½¬æ¢è¯´"æ— æ³•è·å–æ·±åº¦ä¿¡æ¯"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç—‡çŠ¶ï¼šæ£€æµ‹åˆ°å¶å­ä½†è½¬æ¢å¤±è´¥

åŸå› ï¼šRealSenseåœ¨è¯¥åƒç´ å¤„æ— æ³•æµ‹é‡æ·±åº¦

è§£å†³ï¼š
$ ros2 run image_view image_view image:=/camera/camera/aligned_depth_to_color/image_raw

æ£€æŸ¥æ·±åº¦å›¾åƒï¼Œå¶å­å‘¨å›´åº”è¯¥æœ‰é¢œè‰²è€Œéé»‘è‰²

================================================================================
ğŸ“š æ–‡æ¡£å¯¼è§ˆ
================================================================================

æ¨èé˜…è¯»é¡ºåºï¼š

1ï¸âƒ£ ä¸­æ–‡æ€»ç»“.md
   ç›´æ¥å›ç­”æ‚¨çš„é—®é¢˜ï¼Œç®€æ´æ˜äº†

2ï¸âƒ£ README_COORDINATE_TRANSFORM.md
   å®Œæ•´çš„è§£å†³æ–¹æ¡ˆè¯´æ˜å’Œç‰¹æ€§åˆ—è¡¨

3ï¸âƒ£ QUICK_START.md
   å¿«é€Ÿå‚è€ƒå¡ç‰‡ï¼Œå¸¸ç”¨å‘½ä»¤å’Œæ¸…å•

4ï¸âƒ£ LEAF_TO_ARM_GUIDE.md
   è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œé…ç½®å’Œæ•…éšœæ’æŸ¥

5ï¸âƒ£ ARCHITECTURE.md
   ç³»ç»Ÿæ¶æ„å’ŒæŠ€æœ¯ç»†èŠ‚ï¼Œæ•°å­¦å…¬å¼

================================================================================
âœ¨ ç³»ç»Ÿç‰¹æ€§
================================================================================

âœ… å®Œå…¨è‡ªåŠ¨åŒ–
   ä¸€æ¡å‘½ä»¤å¯åŠ¨æ‰€æœ‰ç³»ç»Ÿ

âœ… å®æ—¶å¤„ç†
   æ¯å¸§éƒ½è‡ªåŠ¨è½¬æ¢åæ ‡

âœ… å¯è§†åŒ–æ”¯æŒ
   RVizä¸­æ˜¾ç¤ºç›®æ ‡ä½ç½®ï¼ˆç»¿è‰²çƒä½“ï¼‰

âœ… å®¹é”™æœºåˆ¶
   å¤„ç†æ·±åº¦ç¼ºå¤±å’ŒTFå»¶è¿Ÿ

âœ… æ˜“äºæ‰©å±•
   ç®€å•é›†æˆåˆ°MoveItç­‰ç³»ç»Ÿ

âœ… è¯¦ç»†æ—¥å¿—
   èŠ‚ç‚¹è¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯

================================================================================
ğŸ¯ æ ¸å¿ƒæŠ€æœ¯
================================================================================

1. RealSenseåæŠ•å½±
   å°†2Dåƒç´ åæ ‡ + æ·±åº¦å€¼ â†’ 3Dç›¸æœºåæ ‡
   ä½¿ç”¨: rs2_deproject_pixel_to_point()

2. ROS TF2å˜æ¢
   å°†ç›¸æœºåæ ‡ â†’ æœºæ¢°è‡‚åæ ‡
   ä½¿ç”¨: tf_buffer.lookup_transform()

3. ROSå‘å¸ƒ-è®¢é˜…
   èŠ‚ç‚¹é—´é€šä¿¡ï¼Œé›†æˆåˆ°æ•´ä¸ªç³»ç»Ÿ
   è¯é¢˜: /leaf_detection/arm_target

================================================================================
ğŸ“ ç³»ç»Ÿæ€»ç»“
================================================================================

æ‚¨çš„éœ€æ±‚ï¼š
  æ£€æµ‹åˆ°å¶å­ â†’ è½¬æ¢åˆ°æœºæ¢°è‡‚åæ ‡ç³»

æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼š
  1. åˆ›å»ºä¸“é—¨çš„è½¬æ¢èŠ‚ç‚¹ (leaf_to_arm_transformer.py)
  2. è‡ªåŠ¨å¤„ç†æ‰€æœ‰åæ ‡è½¬æ¢è¿‡ç¨‹
  3. å‘å¸ƒç»“æœåˆ° /leaf_detection/arm_target
  4. æœºæ¢°è‡‚é©±åŠ¨å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªåæ ‡

ä½¿ç”¨æµç¨‹ï¼š
  $ ./start_full_system.sh
  $ ros2 launch ur_robot_driver ... use_fake_hardware:=true
  $ ros2 topic echo /leaf_detection/arm_target
  âœ“ å®Œæˆï¼

ç»“æœï¼š
  æ‚¨ç°åœ¨æœ‰äº†æœºæ¢°è‡‚åæ ‡ç³»ä¸­çš„å¶å­ä½ç½®
  å¯ä»¥ç”¨MoveItè§„åˆ’å’Œæ‰§è¡ŒæŠ“å–åŠ¨ä½œ

================================================================================
ğŸš€ ä¸‹ä¸€æ­¥
================================================================================

1. è¿è¡Œå¯åŠ¨è„šæœ¬
2. éªŒè¯åæ ‡è½¬æ¢å·¥ä½œæ­£å¸¸
3. åœ¨RVizä¸­å¯è§†åŒ–æ‰€æœ‰åæ ‡ç³»
4. é›†æˆåˆ°æ‚¨çš„æ§åˆ¶ç¨‹åº
5. æ‰§è¡Œå®é™…çš„å¶å­é‡‡é›†ä»»åŠ¡

================================================================================
ç‰ˆæœ¬ï¼š1.0
æ›´æ–°æ—¶é—´ï¼š2025-10-21
çŠ¶æ€ï¼šâœ… å·²å®Œå…¨å®ç°
================================================================================
